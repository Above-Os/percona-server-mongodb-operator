


    <title>Update Percona Server for MongoDB Operator &mdash; Percona Kubernetes Operator for Percona Server for MongoDB Documentation</title>
    
  <head>
    
    
    
    <link rel="stylesheet" href="_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.6.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="top" title="Percona Kubernetes Operator for Percona Server for MongoDB Documentation" href="index.html" />
    <link rel="next" title="Scale Percona Server for MongoDB on Kubernetes and OpenShift" href="scaling.html" />
    <link rel="prev" title="Creating a private S3-compatible cloud for backups" href="private.html" /> 
  </head>
  <body>
    <div class="container">  

    <div class="document row">
      <div class="documentwrapper col-md-9 col-md-push-3">
    <div class="related row">
      
      <ul class="nav nav-pills">
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="scaling.html" title="Scale Percona Server for MongoDB on Kubernetes and OpenShift"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="private.html" title="Creating a private S3-compatible cloud for backups"
             accesskey="P">previous</a></li>
        <li><a href="index.html">Percona Kubernetes Operator for Percona Server for MongoDB Documentation</a></li> 
      </ul>
    </div>
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="update-percona-server-for-mongodb-operator">
<span id="operator-updates"></span><h1>Update Percona Server for MongoDB Operator</h1>
<p>Starting from the version 1.1.0 the Percona Kubernetes Operator for MongoDB allows
upgrades to newer versions. This includes upgrades of the
Operator itself, and upgrades of the Percona Server for MongoDB.</p>
<div class="section" id="upgrading-the-operator">
<span id="operator-update"></span><h2>Upgrading the Operator</h2>
<p>This upgrade can be done either in semi-automatic or in manual mode.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Manual update mode is the recommended way for a production cluster.</p>
</div>
<div class="section" id="semi-automatic-upgrade">
<span id="operator-update-semi-auto-updates"></span><h3>Semi-automatic upgrade</h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Only the incremental update to a nearest minor version is supported
(for example, update from 1.4.0 to 1.5.0).
To update to a newer version, which differs from the current version by more
than one, make several incremental updates sequentially.</p>
</div>
<ol class="arabic">
<li><p>Update the Custom Resource Definition file for the Operator, taking it from
the official repository on Github, and do the same for the Role-based access
control:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl apply -f https://raw.githubusercontent.com/percona/percona-server-mongodb-operator/v1.6.0/deploy/crd.yaml
kubectl apply -f https://raw.githubusercontent.com/percona/percona-server-mongodb-operator/v1.6.0/deploy/rbac.yaml
</pre></div>
</div>
</li>
<li><p>Edit the <code class="docutils literal notranslate"><span class="pre">deploy/cr.yaml</span></code> file, setting <code class="docutils literal notranslate"><span class="pre">updateStrategy</span></code> key to
<code class="docutils literal notranslate"><span class="pre">RollingUpdate</span></code>.</p></li>
<li><p>Now you should <a class="reference external" href="https://kubernetes.io/docs/tasks/run-application/update-api-object-kubectl-patch/">apply a patch</a> to your
deployment, supplying necessary image names with a newer version tag. This
is done with the <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">patch</span> <span class="pre">deployment</span></code> command. For example, updating
to the <code class="docutils literal notranslate"><span class="pre">1.6.0</span></code> version should look as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">patch</span> <span class="n">deployment</span> <span class="n">percona</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">mongodb</span><span class="o">-</span><span class="n">operator</span> \
   <span class="o">-</span><span class="n">p</span><span class="s1">&#39;{&quot;spec&quot;:{&quot;template&quot;:{&quot;spec&quot;:{&quot;containers&quot;:[{&quot;name&quot;:&quot;percona-server-mongodb-operator&quot;,&quot;image&quot;:&quot;percona/percona-server-mongodb-operator:1.6.0&quot;}]}}}}&#39;</span>

<span class="n">kubectl</span> <span class="n">patch</span> <span class="n">psmdb</span> <span class="n">my</span><span class="o">-</span><span class="n">cluster</span><span class="o">-</span><span class="n">name</span> <span class="o">--</span><span class="nb">type</span><span class="o">=</span><span class="n">merge</span> <span class="o">--</span><span class="n">patch</span> <span class="s1">&#39;{</span>
   <span class="s2">&quot;spec&quot;</span><span class="p">:</span> <span class="p">{</span>
       <span class="s2">&quot;crVersion&quot;</span><span class="p">:</span><span class="s2">&quot;1.6.0&quot;</span><span class="p">,</span>
       <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="s2">&quot;percona/percona-server-mongodb:4.2.11-12&quot;</span> <span class="p">},</span>
       <span class="s2">&quot;backup&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="s2">&quot;percona/percona-server-mongodb-operator:1.6.0-backup&quot;</span> <span class="p">},</span>
       <span class="s2">&quot;pmm&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="s2">&quot;percona/pmm-client:2.12.0&quot;</span> <span class="p">}</span>
   <span class="p">}}</span><span class="s1">&#39;</span>
</pre></div>
</div>
</li>
<li><p>The deployment rollout will be automatically triggered by the applied patch.
You can track the rollout process in real time using the
<code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">rollout</span> <span class="pre">status</span></code> command with the name of your cluster:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">rollout</span> <span class="n">status</span> <span class="n">sts</span> <span class="n">my</span><span class="o">-</span><span class="n">cluster</span><span class="o">-</span><span class="n">name</span><span class="o">-</span><span class="n">rs0</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="manual-upgrade">
<span id="operator-update-manual-updates"></span><h3>Manual upgrade</h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Only the incremental update to a nearest minor version of the Operator
is supported (for example, update from 1.2.0 to 1.3.0).
To update to a newer version, which differs from the current version by more
than one, make several incremental updates sequentially.</p>
</div>
<ol class="arabic">
<li><p>Update the Custom Resource Definition file for the Operator, taking it from
the official repository on Github, and do the same for the Role-based access
control:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl apply -f https://raw.githubusercontent.com/percona/percona-server-mongodb-operator/v1.6.0/deploy/crd.yaml
kubectl apply -f https://raw.githubusercontent.com/percona/percona-server-mongodb-operator/v1.6.0/deploy/rbac.yaml
</pre></div>
</div>
</li>
<li><p>Edit the <code class="docutils literal notranslate"><span class="pre">deploy/cr.yaml</span></code> file, setting <code class="docutils literal notranslate"><span class="pre">updateStrategy</span></code> key to
<code class="docutils literal notranslate"><span class="pre">OnDelete</span></code>.</p></li>
<li><p>Now you should <a class="reference external" href="https://kubernetes.io/docs/tasks/run-application/update-api-object-kubectl-patch/">apply a patch</a> to your
deployment, supplying necessary image names with a newer version tag. This
is done with the <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">patch</span> <span class="pre">deployment</span></code> command. For example, updating
to the <code class="docutils literal notranslate"><span class="pre">1.6.0</span></code> version should look as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">patch</span> <span class="n">deployment</span> <span class="n">percona</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">mongodb</span><span class="o">-</span><span class="n">operator</span> \
   <span class="o">-</span><span class="n">p</span><span class="s1">&#39;{&quot;spec&quot;:{&quot;template&quot;:{&quot;spec&quot;:{&quot;containers&quot;:[{&quot;name&quot;:&quot;percona-server-mongodb-operator&quot;,&quot;image&quot;:&quot;percona/percona-server-mongodb-operator:1.6.0&quot;}]}}}}&#39;</span>

<span class="n">kubectl</span> <span class="n">patch</span> <span class="n">psmdb</span> <span class="n">my</span><span class="o">-</span><span class="n">cluster</span><span class="o">-</span><span class="n">name</span> <span class="o">--</span><span class="nb">type</span><span class="o">=</span><span class="n">merge</span> <span class="o">--</span><span class="n">patch</span> <span class="s1">&#39;{</span>
   <span class="s2">&quot;spec&quot;</span><span class="p">:</span> <span class="p">{</span>
       <span class="s2">&quot;crVersion&quot;</span><span class="p">:</span><span class="s2">&quot;1.6.0&quot;</span><span class="p">,</span>
       <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="s2">&quot;percona/percona-server-mongodb:4.2.11-12&quot;</span> <span class="p">},</span>
       <span class="s2">&quot;backup&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="s2">&quot;percona/percona-server-mongodb-operator:1.6.0-backup&quot;</span> <span class="p">},</span>
       <span class="s2">&quot;pmm&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="s2">&quot;percona/pmm-client:2.12.0&quot;</span> <span class="p">}</span>
   <span class="p">}}</span><span class="s1">&#39;</span>
</pre></div>
</div>
</li>
<li><p>Pod with the newer Percona Server for MongoDB image will start after you
delete it. Delete targeted Pods manually one by one to make them restart in
the desired order:</p>
<ol class="arabic">
<li><p>Delete the Pod using its name with the command like the following one:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">delete</span> <span class="n">pod</span> <span class="n">my</span><span class="o">-</span><span class="n">cluster</span><span class="o">-</span><span class="n">name</span><span class="o">-</span><span class="n">rs0</span><span class="o">-</span><span class="mi">2</span>
</pre></div>
</div>
</li>
<li><p>Wait until Pod becomes ready:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">get</span> <span class="n">pod</span> <span class="n">my</span><span class="o">-</span><span class="n">cluster</span><span class="o">-</span><span class="n">name</span><span class="o">-</span><span class="n">rs0</span><span class="o">-</span><span class="mi">2</span>
</pre></div>
</div>
<p>The output should be like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">NAME</span>                    <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">my</span><span class="o">-</span><span class="n">cluster</span><span class="o">-</span><span class="n">name</span><span class="o">-</span><span class="n">rs0</span><span class="o">-</span><span class="mi">2</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">3</span><span class="n">m33s</span>
</pre></div>
</div>
</li>
</ol>
</li>
<li><p>The update process is successfully finished when all Pods have been
restarted.</p></li>
</ol>
</div>
</div>
<div class="section" id="upgrading-percona-server-for-mongodb">
<span id="operator-update-smartupdates"></span><h2>Upgrading Percona Server for MongoDB</h2>
<p>Starting from version 1.5.0, the Operator can do fully automatic upgrades to
the newer versions of Percona Server for MongoDB within the method named <em>Smart
Updates</em>.</p>
<p>To have this upgrade method enabled, make sure that the <code class="docutils literal notranslate"><span class="pre">updateStrategy</span></code> key
in the <code class="docutils literal notranslate"><span class="pre">deploy/cr.yaml</span></code> configuration file is set to <code class="docutils literal notranslate"><span class="pre">SmartUpdate</span></code>.</p>
<p>When automatic updates are enabled, the Operator will carry on upgrades
according to the following algorithm. It will query a special <em>Version Service</em>
server at scheduled times to obtain fresh information about version numbers and
valid image paths needed for the upgrade. If the current version should be
upgraded, the Operator updates the CR to reflect the new image paths and carries
on sequential Pods deletion in a safe order, allowing StatefulSet to redeploy
the cluster Pods with the new image.</p>
<p>The upgrade details are set in the <code class="docutils literal notranslate"><span class="pre">upgradeOptions</span></code> section of the
<code class="docutils literal notranslate"><span class="pre">deploy/cr.yaml</span></code> configuration file. Make the following edits to configure
updates:</p>
<ol class="arabic">
<li><p>Set the <code class="docutils literal notranslate"><span class="pre">apply</span></code> option to one of the following values:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">Recommended</span></code> - automatic upgrades will choose the most recent version
of software flagged as Recommended (for clusters created from scratch,
the PSMDB 4.2 version will be selected instead of the PSMDB 4.0 one
regardless of the image path; for already existing clusters, the 4.2
vs. 4.0 branch choice will be preserved),</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Latest</span></code> - automatic upgrades will choose the most recent version of
the software available (for clusters created from scratch,
the PSMDB 4.2 version will be selected instead of the PSMDB 4.0 one
regardless of the image path; for already existing clusters, the 4.2
vs. 4.0 branch choice will be preserved),</p></li>
<li><p><em>specific version number</em> - will apply an upgrade if the running PSMDB
version doesn’t match the explicit version number with no future upgrades
(version numbers are specified as <code class="docutils literal notranslate"><span class="pre">4.2.8-8</span></code>, <code class="docutils literal notranslate"><span class="pre">4.2.7-7</span></code>,
<code class="docutils literal notranslate"><span class="pre">4.0.19-12</span></code>, etc.),</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Never</span></code> or <code class="docutils literal notranslate"><span class="pre">Disabled</span></code> - disable automatic upgrades</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When automatic upgrades are disabled by the <code class="docutils literal notranslate"><span class="pre">apply</span></code> option,
Smart Update functionality will continue working for changes triggered
by other events, such as rotating a password, or
changing resource values.</p>
</div>
</li>
</ul>
</li>
<li><p>Make sure the <code class="docutils literal notranslate"><span class="pre">versionServiceEndpoint</span></code> key is set to a valid Version
Server URL (otherwise Smart Updates will not occur).</p>
<ol class="upperalpha">
<li><p>You can use the URL of the official Percona’s Version Service (default).
Set <code class="docutils literal notranslate"><span class="pre">versionServiceEndpoint</span></code> to <code class="docutils literal notranslate"><span class="pre">https://check.percona.com</span></code>.</p></li>
<li><p>Alternatively, you can run Version Service inside your cluster. This
can be done with the <code class="docutils literal notranslate"><span class="pre">kubectl</span></code> command as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl run version-service --image<span class="o">=</span>perconalab/version-service --env<span class="o">=</span><span class="s2">&quot;SERVE_HTTP=true&quot;</span> --port <span class="m">11000</span> --expose
</pre></div>
</div>
</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Version Service is never checked if automatic updates are disabled.
If automatic updates are enabled, but Version Service URL can not be
reached, upgrades will not occur.</p>
</div>
</li>
<li><p>Use the <code class="docutils literal notranslate"><span class="pre">schedule</span></code> option to specify the update checks time in CRON format.</p></li>
</ol>
<p>The following example sets the midnight update checks with the official
Percona’s Version Service:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">spec</span><span class="p">:</span>
  <span class="nt">updateStrategy</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">SmartUpdate</span>
  <span class="nt">upgradeOptions</span><span class="p">:</span>
    <span class="nt">apply</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Recommended</span>
    <span class="nt">versionServiceEndpoint</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">https://check.percona.com</span>
    <span class="nt">schedule</span><span class="p">:</span> <span class="s">&quot;0</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*&quot;</span>
<span class="nn">...</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
    <div class="related row">
      
      <ul class="nav nav-pills">
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="scaling.html" title="Scale Percona Server for MongoDB on Kubernetes and OpenShift"
             >next</a></li>
        <li class="right" >
          <a href="private.html" title="Creating a private S3-compatible cloud for backups"
             >previous</a></li>
        <li><a href="index.html">Percona Kubernetes Operator for Percona Server for MongoDB Documentation</a></li> 
      </ul>
    </div>
      </div>
      <div class="sphinxsidebar  col-md-3 col-md-pull-9">
        <div class="sphinxsidebarwrapper">
  
          {@ product_logo @}          

          {@ product_pdf_download @}
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Update Percona Server for MongoDB Operator</a><ul>
<li><a class="reference internal" href="#upgrading-the-operator">Upgrading the Operator</a><ul>
<li><a class="reference internal" href="#semi-automatic-upgrade">Semi-automatic upgrade</a></li>
<li><a class="reference internal" href="#manual-upgrade">Manual upgrade</a></li>
</ul>
</li>
<li><a class="reference internal" href="#upgrading-percona-server-for-mongodb">Upgrading Percona Server for MongoDB</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="private.html"
                        title="previous chapter">Creating a private S3-compatible cloud for backups</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="scaling.html"
                        title="next chapter">Scale Percona Server for MongoDB on Kubernetes and OpenShift</a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">jQuery(document).ready(function(){ jQuery('#searchbox').show(0); });</script>
          {@ product_series @}
        </div>
      </div>
      <div class="clearer"></div>
    </div>
 <script type="text/javascript">
   ( function($) {
     $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
           $(this).parent().children().not(".header").toggle(400);
           $(this).parent().children(".header").toggleClass("open");
        })
     });
   } ) ( jQuery );
</script>

  </div>
  </body>
